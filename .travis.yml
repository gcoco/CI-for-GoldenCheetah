language: cpp
compiler: gcc
sudo: required
dist: trusty
  
before_install:
  - export QT_SELECT=qt5
  - sudo apt-get update -qq
  - sudo apt-get install -qq build-essential git cmake flex bison
  - sudo apt-get install -qq qt5-default qttools5-dev-tools
  - sudo apt-get install -qq libqt5svg5-dev qtmultimedia5-dev libqt5serialport5-dev libudev-dev libqt5webkit5-dev
  - sudo apt-get install -qq libssl-dev libical-dev libusb-1.0-0-dev libudev-dev libsamplerate0-dev
  - sudo apt-get install -qq libvlc-dev libvlccore-dev
before_script:
  - pwd
  # SRMIO build 
  - wget http://www.zuto.de/project/files/srmio/srmio-0.1.1~git1.tar.gz -O srmio-0.1.1~git1.tar.gz
  - tar xf srmio-0.1.1~git1.tar.gz
  - cd srmio-0.1.1~git1
  - ./configure --disable-shared --enable-static --prefix=`cd ..; pwd`/usr
  - make -j3 install
  - cd ..
  # QWTPLOT3D build
  - git clone --depth 1 https://github.com/sintegrial/qwtplot3d.git qwtplot3d
  - cd qwtplot3d
  - sed -i "s|examples||" qwtplot3d.pro
  - qmake -recursive
  - make -j3
  - cd ..
  # libkml build
  - wget https://github.com/libkml/libkml/archive/1.3.0.tar.gz -O libkml-1.3.0.tar.gz
  - tar xf libkml-1.3.0.tar.gz
  - cd libkml-1.3.0
  - mkdir build && cd build
  - cmake .. -DBUILD_SHARED_LIBS=off -DCMAKE_INSTALL_PREFIX=`cd ../..; pwd;`/usr
  - make -j3 install
  - cd ../..
  # libusb-compat build
  - wget https://sourceforge.net/projects/libusb/files/libusb-compat-0.1/libusb-compat-0.1.5/libusb-compat-0.1.5.tar.bz2/download -O libusb-compat-0.1.5.tar.bz2
  - tar xf libusb-compat-0.1.5.tar.bz2
  - cd libusb-compat-0.1.5
  - ./configure --disable-shared --enable-static --prefix=`cd ..; pwd`/usr
  - make -j3 install 
  - cd ..
# Setup GoldenCheetah
  - pwd && ls
  - git clone --depth 1 git://github.com/GoldenCheetah/GoldenCheetah.git
  - cd GoldenCheetah
  - cp qwt/qwtconfig.pri.in qwt/qwtconfig.pri
  - cp src/gcconfig.pri.in src/gcconfig.pri
  - sed -i "s|#\(CONFIG += release.*\)|\1 static|" src/gcconfig.pri
  - sed -i "s|#\(QMAKE_LRELEASE = \).*|\1 lrelease|" src/gcconfig.pri
  - sed -i "s|^#QMAKE_CXXFLAGS|QMAKE_CXXFLAGS|" src/gcconfig.pri
  - sed -i "s|#\(SRMIO_INSTALL =.*\)|\1 ../../usr|" src/gcconfig.pri
  - sed -i "s|#\(QWT3D_INSTALL =.*\)|\1 ../../qwtplot3d|" src/gcconfig.pri
  - sed -i "s|#\(KML_INSTALL =\).*|\1 ../../usr|" src/gcconfig.pri
  - sed -i "s|#\(ICAL_INSTALL =.*\)|\1 /usr|" src/gcconfig.pri
  - sed -i "s|#\(ICAL_LIBS    =.*\)|\1 -lical|" src/gcconfig.pri
  - sed -i "s|#\(LIBUSB_INSTALL =\).*|\1 ../../usr|" src/gcconfig.pri
  - sed -i "s|#\(LIBUSB_LIBS    =.*\)|\1 ../../usr/lib/libusb.a -lusb-1.0 -ldl -ludev|" src/gcconfig.pri
  - sed -i "s|#\(VLC_INSTALL =.*\)|\1 /usr|" src/gcconfig.pri
  - sed -i "s|#\(VLC_LIBS    =.*\)|\1 -lvlc -lvlccore|" src/gcconfig.pri
  - sed -i "s|#\(SAMPLERATE_INSTALL =\).*|\1 /usr|" src/gcconfig.pri
  - sed -i "s|#\(SAMPLERATE_LIBS =\).*|\1 -lsamplerate|" src/gcconfig.pri
  - sed -i "s|^#LIBZ_LIBS|LIBZ_LIBS|" src/gcconfig.pri
  - sed -i "s|^#HTPATH|HTPATH|" src/gcconfig.pri
  - sed -i "s|\(DEFINES += GC_VIDEO_NONE.*\)|#\1 |" src/gcconfig.pri
  - sed -i "s|#\(DEFINES += GC_VIDEO_VLC.*\)|\1|" src/gcconfig.pri
  - cat src/gcconfig.pri
  - lupdate src/src.pro

script:
  - qmake -recursive
  - make -j3

after_success:
  - ldd src/GoldenCheetah
  - src/GoldenCheetah --version
